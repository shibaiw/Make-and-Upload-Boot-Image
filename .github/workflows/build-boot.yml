name: Make and Upload Boot Image

on:
  workflow_dispatch:

jobs:
  build:
    name: Package Boot Image
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Load Configuration
      run: |
        # 读取 config.env 中的 BOOT_URL 和 IMAGE_URL
        if [ -f config.env ]; then
          while IFS='=' read -r key value; do
            [[ $key =~ ^#.* ]] || [ -z "$key" ] && continue
            echo "$key=$(echo $value | xargs)" >> $GITHUB_ENV
          done < config.env
        else
          echo "Error: config.env not found" && exit 1
        fi

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip git wget
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    - name: Download Files
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        # 下载原始 boot
        wget -q -O boot-source.img "${{ env.BOOT_URL }}"
        # 下载内核 Image (保持你逻辑中的变量对应)
        wget -q -O Image "${{ env.IMAGE_URL }}"
        
        if [ ! -s boot-source.img ] || [ ! -s Image ]; then
            echo "Download failed or file empty" && exit 1
        fi
        echo "HAVE_SOURCE_BOOT_IMAGE=true" >> $GITHUB_ENV
        echo "CHECK_FILE_IS_OK=true" >> $GITHUB_ENV

    - name: Download mkbootimg tools
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone https://android.googlesource.com/platform/system/tools/mkbootimg tools -b master-kernel-build-2022 --depth=1

    - name: Make boot image
      if: env.HAVE_SOURCE_BOOT_IMAGE == 'true' && env.CHECK_FILE_IS_OK == 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        
        # 1. 自动提取格式化参数
        echo "FORMAT_MKBOOTING=$(python3 tools/unpack_bootimg.py --boot_img boot-source.img --format mkbootimg)" >> $GITHUB_ENV
        
        # 2. 按照你要求的逻辑执行：解包 -> 替换 -> 打包
        python3 tools/unpack_bootimg.py --boot_img boot-source.img --out out
        
        # 将下载的 Image 覆盖到解包出来的 out/kernel
        cp Image out/kernel
        
        # 使用提取的参数重新封装
        python3 tools/mkbootimg.py ${{ env.FORMAT_MKBOOTING }} -o boot.img
        
        if [ -f boot.img ]; then
            echo "MAKE_BOOT_IMAGE_IS_OK=true" >> $GITHUB_ENV
        else
            echo "Boot image is empty"
            exit 1
        fi

    - name: Upload boot image
      if: env.MAKE_BOOT_IMAGE_IS_OK == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: patched-boot-image
        path: kernel_workspace/boot.img
