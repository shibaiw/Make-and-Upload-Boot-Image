name: Make and Upload Boot Image

on:
  workflow_dispatch:
  push:
    paths:
      - 'config.env'  # 当你修改并推送 config.env 时也会自动触发

jobs:
  build:
    name: Package Boot Image
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Load Configuration
      run: |
        # 读取 config.env 并写入到 GITHUB_ENV 供后续步骤使用
        while IFS='=' read -r key value; do
          if [[ ! $key =~ ^# && -n $key ]]; then
            echo "$key=$value" >> $GITHUB_ENV
          fi
        done < config.env

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip git wget
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    - name: Download Files
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        # 使用从配置文件中读取的变量
        wget -O boot-source.img "${{ env.BOOT_URL }}"
        wget -O Image "${{ env.IMAGE_URL }}"
        
        if [ ! -s boot-source.img ] || [ ! -s Image ]; then
            echo "错误: 下载失败，请检查 config.env 中的链接是否正确且为直连"
            exit 1
        fi

    - name: Download mkbootimg tools
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone https://android.googlesource.com/platform/system/tools/mkbootimg tools -b master-kernel-build-2022 --depth=1

    - name: Prepare and Replace Kernel
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        
        # 1. 提取打包参数
        FORMAT_MKBOOTING=$(python3 tools/unpack_bootimg.py --boot_img boot-source.img --format mkbootimg)
        echo "FORMAT_MKBOOTING=$FORMAT_MKBOOTING" >> $GITHUB_ENV
        
        # 2. 解包
        python3 tools/unpack_bootimg.py --boot_img boot-source.img --out out
        
        # 3. 替换内核
        if [ -f out/kernel ]; then
            cp Image out/kernel
            echo "PROCESS_READY=true" >> $GITHUB_ENV
        else
            echo "解包失败，未找到内核文件"
            exit 1
        fi

    - name: Make boot image
      if: env.PROCESS_READY == 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        python3 tools/mkbootimg.py ${{ env.FORMAT_MKBOOTING }} -o new-boot.img
        
        if [ -f new-boot.img ]; then
            echo "MAKE_BOOT_IMAGE_OK=true" >> $GITHUB_ENV
        fi

    - name: Upload boot image
      if: env.MAKE_BOOT_IMAGE_OK == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: patched-boot-image
        path: kernel_workspace/new-boot.img
