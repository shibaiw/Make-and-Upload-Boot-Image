name: Make and Upload Boot Image

on:
  workflow_dispatch:

jobs:
  build:
    name: Package Boot Image
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Load Configuration
      run: |
        if [ -f config.env ]; then
          while IFS='=' read -r key value; do
            [[ $key =~ ^#.* ]] || [ -z "$key" ] && continue
            echo "$key=$(echo $value | xargs)" >> $GITHUB_ENV
          done < config.env
        else
          echo "config.env missing" && exit 1
        fi

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip git wget
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    - name: Download Files
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        # 使用 -P . 下载并保持原文件名
        wget -q "${{ env.BOOT_URL }}"
        wget -q "${{ env.IMAGE_URL }}"
        
        # 自动识别下载后的文件名
        # 假设目录下只有两个下载的文件，一个是 boot 镜像，一个是内核
        # 我们根据文件大小或关键字简单区分
        echo "ORIGINAL_BOOT_FILE=$(basename "${{ env.BOOT_URL }}")" >> $GITHUB_ENV
        echo "NEW_KERNEL_FILE=$(basename "${{ env.IMAGE_URL }}")" >> $GITHUB_ENV

    - name: Download mkbootimg tools
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone https://android.googlesource.com/platform/system/tools/mkbootimg tools -b master-kernel-build-2022 --depth=1

    - name: Prepare and Replace Kernel
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        
        # 1. 提取参数（使用下载的原始文件名）
        FORMAT_MKBOOTING=$(python3 tools/unpack_bootimg.py --boot_img "${{ env.ORIGINAL_BOOT_FILE }}" --format mkbootimg)
        echo "FORMAT_MKBOOTING=$FORMAT_MKBOOTING" >> $GITHUB_ENV
        
        # 2. 解包
        python3 tools/unpack_bootimg.py --boot_img "${{ env.ORIGINAL_BOOT_FILE }}" --out out
        
        # 3. 核心：自动对应替换
        # 无论你下载的文件叫 Image, Image.gz 还是 kernel_new
        # 只要它是从 IMAGE_URL 下载来的，我们就用它覆盖解包出来的内核组件
        if [ -f out/kernel ]; then
            cp "${{ env.NEW_KERNEL_FILE }}" out/kernel
            echo "已自动将 ${{ env.NEW_KERNEL_FILE }} 替换到内核位置"
            echo "PROCESS_READY=true" >> $GITHUB_ENV
        else
          echo "解包异常" && exit 1
        fi

    - name: Make boot image
      if: env.PROCESS_READY == 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        python3 tools/mkbootimg.py ${{ env.FORMAT_MKBOOTING }} -o new-boot.img
        
        if [ -f new-boot.img ]; then
            echo "MAKE_BOOT_IMAGE_OK=true" >> $GITHUB_ENV
        fi

    - name: Upload boot image
      if: env.MAKE_BOOT_IMAGE_OK == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: patched-boot-image
        path: kernel_workspace/new-boot.img
